<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>gaia-transmitter-js</title>
    <script src="dist/gaia-js-sdk-convey.min.js"></script>
    <link rel="stylesheet" href="dist/gaia-js-sdk-convey.min.css">
</head>
<body>

<div class="gaia">
    <div class="gaia-chat">
        <div class="header" id="chat-header"></div>
        <div class="messages scrollbar" id="chat-messages"></div>
        <div class="control" id="chat-control">
            <textarea class="messageInput" id="chat-messageInput"></textarea>
            <button class="sendButton" id="chat-sendButton"></button>
        </div>
        <div class="footer" id="chat-footer"></div>
    </div>
</div>

</body>
<script>
    document.addEventListener("DOMContentLoaded", function(){
        let emitter = {
            onPreRender: (message, outgoing) => {
                if (message.type === "container" && message.elements[message.elements.length - 1].type === "text") {
                    let input = message.elements[message.elements.length - 1].text;
                    if (input.includes("*clear*")) {
                        clearChat();
                        document.getElementById('chat-control').hidden = false;
                    } else if (input.includes("*textreply*")) {
                        document.getElementById('chat-control').hidden = false;
                        message.elements[message.elements.length - 1].text =
                            message.elements[message.elements.length - 1].text.replace("*textreply*", "");
                    } else {
                        document.getElementById('chat-control').hidden = false;
                    }
                } else {
                    document.getElementById('chat-control').hidden=true;
                }

                if (outgoing) {
                    return Promise.resolve(message);
                }

                return new Promise((resolve) => {
                    if (message.elements[0].text === '*map*') {
                        resolve({
                            elements: [
                                {
                                    type: 'text',
                                    text: 'Bitte wähle das Gebiet aus, in dem du dir vorstellen könntest zu arbeiten.'
                                },
                                {
                                    type: 'map',
                                    markers: [
                                        [48.201122, 16.374096],
                                        [48.174854, 16.331057],
                                        [48.2052, 16.372101],
                                        [48.173862, 16.417097],
                                        [48.211796, 16.375935],
                                        [48.298306, 14.291737],
                                        [47.800102, 13.041978],
                                        [47.066689, 15.441539],
                                        [48.239582, 16.431065],
                                        [47.196598, 11.39716],
                                        [48.112587, 16.316097],
                                        [48.192936, 16.275846],
                                        [47.4459, 12.3898],
                                        [47.774761, 13.068038],
                                        [48.207664, 16.372374],
                                        [48.216301, 16.341574],
                                        [47.829018, 16.251837],
                                        [47.420795, 15.274275],
                                        [47.055412, 15.448221],
                                        [48.165237, 16.34647],
                                        [48.213703, 16.362692],
                                        [46.629536, 14.354836],
                                        [48.04269, 14.433714],
                                        [48.179642, 14.06326],
                                        [48.220001, 16.444101],
                                        [47.045532, 15.430638],
                                        [48.208958, 16.335102],
                                        [48.254082, 14.282057],
                                        [48.25753, 16.400484],
                                        [46.605309, 13.865604],
                                        [48.280624, 16.411858],
                                        [46.823643, 14.839535],
                                        [48.250202, 16.470798],
                                        [47.283249, 16.186424],
                                        [48.211369, 14.279418],
                                        [47.490559, 9.705108],
                                        [47.859444, 13.125164],
                                        [47.593456, 12.17665],
                                        [47.257057, 11.323176],
                                        [48.10854, 14.836826],
                                        [47.809799, 13.0616],
                                        [47.104416, 15.400177],
                                        [48.246517, 16.342239],
                                        [48.00478, 13.673107],
                                        [48.303394, 16.576574],
                                        [48.198853, 16.319983],
                                        [47.151684, 9.814565],
                                        [48.239807, 14.527962],
                                        [48.322552, 16.027237],
                                        [47.058304, 16.067472],
                                        [47.267502, 11.3936],
                                        [48.1483, 16.342501],
                                        [47.172153, 14.631542],
                                        [46.614677, 13.847033],
                                        [48.253525, 13.044782],
                                        [47.350349, 11.698958],
                                        [46.805725, 15.560583],
                                        [47.052906, 15.126175],
                                        [48.290615, 14.297446],
                                        [47.277416, 11.456435],
                                        [47.828495, 16.531519],
                                        [48.076126, 16.330383],
                                        [47.843899, 16.2463],
                                        [47.561447, 14.247388],
                                        [48.152683, 16.301764],
                                        [48.564014, 16.074135],
                                        [47.028301, 15.4008],
                                        [47.990067, 16.275312],
                                        [48.510521, 14.501155],
                                        [47.230865, 10.7445],
                                        [48.159328, 16.470924],
                                        [48.358948, 16.312408],
                                        [47.816124, 13.005838],
                                        [48.602093, 15.186856],
                                        [47.718678, 16.07147],
                                        [47.206704, 15.638209],
                                        [48.243176, 16.361937],
                                        [48.225727, 16.36124],
                                        [48.197571, 16.348345],
                                        [47.710602, 13.6213],
                                        [48.243275, 14.235785],
                                        [48.212658, 13.483068],
                                        [47.931324, 16.204748],
                                        [47.381332, 11.833501],
                                        [47.426228, 9.740366],
                                        [47.518948, 12.41619],
                                        [46.956623, 15.882822],
                                        [47.482555, 10.724835],
                                        [47.283658, 15.99531],
                                        [48.304321, 14.288406],
                                        [48.260159, 16.411135],
                                        [46.640438, 14.292003],
                                        [47.429008, 12.843672],
                                        [48.153557, 13.987617],
                                        [48.112801, 16.3027],
                                        [48.328938, 14.312246],
                                        [46.829655, 12.772283],
                                        [46.819374, 15.228687],
                                        [47.931194, 13.7857],
                                    ],
                                    center: [47.931194, 13.7857],
                                    zoom: 13,
                                    leafletSettings: {
                                        minZoom: 10,
                                        maxZoom: 14
                                    }
                                },
                                {
                                    type: 'submit',
                                    text: 'submit'
                                },
                            ],
                            position: 'left',
                            timestamp: 1,
                            type: 'block'
                        });
                    } else {
                        resolve(message);
                    }
                });
            }
        };

        let channel = new GaiaChannel("#chat-messages", "f09e3cdd-b25c-4107-99df-7b6f97e90798", emitter);
        let promise = channel.connect("ws://localhost:61616");

        let contextCallback = function (message) {
            console.log(message);
        };

        promise.then(() => {
            // the channel is ready to use
        });

        channel.subscribe(channel.inboundTextDestination);
        channel.subscribe(channel.inboundContextDestination, contextCallback);
        channel.servus();

        document.getElementById("chat-messageInput").addEventListener("keyup", ((ev) => {
            if (ev.keyCode === 13) {
                send(document.getElementById("chat-messageInput").value);
            }
        }));

        document.getElementById("chat-sendButton").addEventListener("click", (() => {
            send(document.getElementById("chat-messageInput").value);
        }));

        function send(value) {
            if (value.replace(/^\s+|\s+$/g,"") !== "") {
                channel.sendMessage(channel.outboundTextDestination, {type: "text", text: value});
            }
            clearMessageInput();
        }

        function clearChat() {
            document.getElementById("chat-messages").innerHTML = '';
        }

        function clearMessageInput() {
            document.getElementById("chat-messageInput").value = '';
        }
    });
</script>
</html>
