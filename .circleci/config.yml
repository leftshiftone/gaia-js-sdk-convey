version: 2
jobs:
  build:
    docker:
      - image: circleci/node:lts-browsers
    steps:
      - checkout
      - restore_cache:
          key: cache-node-{{ checksum "package.json" }}
      - run:
          name: "Download dependencies"
          command: yarn install
      - save_cache:
          paths:
            - ./node_modules
          key: cache-node-{{ checksum "package.json" }}
      - run:
          name: "Build"
          command: yarn build
  release-major:
    docker:
      - image: circleci/node:lts-browsers
    steps:
      - add_ssh_keys:
          fingerprints:
            - "1a:f6:58:1d:a6:ba:b3:b6:6e:37:69:b7:96:3c:e1:f9"
      - checkout
      - run:
          name: "Configure git user"
          command: git config --local user.email "ci@leftshift.one" && git config --local user.name "Continuous Integration"
      - restore_cache:
          key: cache-node-{{ checksum "package.json" }}
      - run:
          name: "Download dependencies"
          command: yarn install
      - save_cache:
          paths:
            - ./node_modules
          key: cache-node-{{ checksum "package.json" }}
      - run:
          name: "Build"
          command: yarn build
      - run:
          name: "Release"
          command: yarn release:major
      - run:
          name: "Cleanup release"
          command: yarn cleanup-release:major
  release-minor:
    docker:
      - image: circleci/node:lts-browsers
    steps:
      - add_ssh_keys:
          fingerprints:
            - "1a:f6:58:1d:a6:ba:b3:b6:6e:37:69:b7:96:3c:e1:f9"
      - checkout
      - run:
          name: "Configure git user"
          command: git config --local user.email "ci@leftshift.one" && git config --local user.name "Continuous Integration"
      - restore_cache:
          key: cache-node-{{ checksum "package.json" }}
      - run:
          name: "Download dependencies"
          command: yarn install
      - save_cache:
          paths:
            - ./node_modules
          key: cache-node-{{ checksum "package.json" }}
      - run:
          name: "Build"
          command: yarn build
      - run:
          name: "Release"
          command: yarn release:minor
      - run:
          name: "Cleanup release"
          command: yarn cleanup-release:minor
  release-patch:
    docker:
      - image: circleci/node:lts-browsers
    steps:
      - add_ssh_keys:
          fingerprints:
            - "1a:f6:58:1d:a6:ba:b3:b6:6e:37:69:b7:96:3c:e1:f9"
      - checkout
      - run:
          name: "Configure git user"
          command: git config --local user.email "ci@leftshift.one" && git config --local user.name "Continuous Integration"
      - restore_cache:
          key: cache-node-{{ checksum "package.json" }}
      - run:
          name: "Download dependencies"
          command: yarn install
      - save_cache:
          paths:
            - ./node_modules
          key: cache-node-{{ checksum "package.json" }}
      - run:
          name: "Build"
          command: yarn build
      - run:
          name: "Release"
          command: yarn release:patch
      - run:
          name: "Cleanup release"
          command: yarn cleanup-release:patch

workflows:
  version: 2
  test:
    jobs:
      - build
      - release-major:
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^release-major$/
      - release-minor:
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^release-minor$/
      - release-patch:
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^release-patch$/
